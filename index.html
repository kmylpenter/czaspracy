<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Rejestracja czasu pracy</title>

 <script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>


  <style>
    body::after {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: url('https://raw.githubusercontent.com/kmylpenter/czaspracy/main/Finalkmylpenter_3.0_trademark_final.png') no-repeat center center;
      background-size: contain;
      opacity: 0.03;
      pointer-events: none;
      z-index: 0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f9f9f9;
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Nag≈Ç√≥wki i nawigacja */
    #clock,
    .nav-bar,
    #step-title {
      width: 100%;
      text-align: center;
      margin-bottom: 0.75rem;
    }
    .nav-bar {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    @media (max-width: 600px) {
      .nav-bar button {
        flex: 1 1 auto;
        min-width: 80px;
      }
    }

    h2 {
      margin: 20px 0 0 0;
    }

    /* Przyciski */
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 1.2rem;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background: #3a84ff;
      color: white;
      transition: background 0.2s;
    }
    button:hover {
      background: #5aa0ff;
    }
    .back-button {
      background: #e0e0e0;
      color: #333;
    }
    .back-button:hover {
      background: #d0d0d0;
    }

    /* Ekrany/sekcje */
    .screen {
      display: none;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }
    .active {
      display: flex;
    }

    /* Siatki */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
      margin: 20px;
      width: 90%;
      max-width: 800px;
    }
    .grid.project-group {
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 0.5rem;
    }

    /* Tytu≈Çy grup */
    .group-title {
      width: 90%;
      max-width: 800px;
      font-weight: bold;
      margin: 1rem 0 0.5rem;
      text-align: left;
    }

    /* Kafelki */
    .tile {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 1rem;
      font-size: clamp(0.8rem, 2.5vw, 1.1rem);
      line-height: 1.2;
      word-break: break-word;
      white-space: pre-wrap;
      background: #fff;
      color: #222;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.2s ease-in-out;
    }
    .tile:hover {
      background: #f0f0f0;
      transform: scale(1.05);
    }
    .tile.selected {
      background: #d0e8ff;
      border: 2px solid #3a84ff;
    }

    /* Status pracownik√≥w */
    .tile-status-green {
      background: #d4edda !important;
      border: 2px solid #28a745;
    }
    .tile-status-yellow {
      background: #fff3cd !important;
      border: 2px solid #ffc107;
    }
    .tile-status-red {
      background: #f8d7da !important;
      border: 2px solid #dc3545;
    }

    /* Kroki kolor√≥w */
    .tile-step1 { background: #ffffff; }
    .tile-step2 { background: #e6f7ff; }
    .tile-step3 { background: #fdf5e6; }
    .tile-step4 { background: #e6ffe6; }

    /* Animacja klikniƒôcia */
    .tile.clicked {
      animation: pop 0.2s ease-out;
    }
    @keyframes pop {
      0%   { transform: scale(1); }
      50%  { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Kafelki godzin */
    .hour-options {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 10px;
      margin-top: 10px;
      width: 90%;
      max-width: 800px;
    }
    .hour-options .tile {
      white-space: nowrap;
      min-width: 2rem;
    }

    /* Podsumowanie */
    .summary-entry {
      margin: 10px 0;
      padding: 10px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .summary-entry-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      justify-content: center;
      max-width: 800px;
      margin: 20px auto;
    }
    .total-hours {
      font-size: 2.5rem;
      font-weight: bold;
      margin-left: 20px;
    }
    .total-hours.red { color: #d80000; }
    .total-hours.green { color: #006400; }
    .remove-btn {
      float: right;
      background: none;
      border: none;
      font-size: 1.2rem;
      color: #d80000;
      cursor: pointer;
      margin-top: -10px;
    }
    .remove-btn:hover { color: #ff0000; }

    /* Popup i toast */
    #entries-popup table td > button {
      padding: 0;
      margin: 0;
      line-height: 1;
      font-size: inherit;
      background: none;
      border: none;
      cursor: pointer;
      vertical-align: middle;
    }
    #toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #28a745;
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 1rem;
      display: none;
      z-index: 9999;
    }
    #toast.error { background: #d80000; }
</style>

</head>
<body>
<h3 id="clock" style="margin-top: 0;"></h3>
<div id="toast"></div>

  <div class="nav-bar" id="backButtonContainer">
  <button class="back-button" onclick="goBack()">‚¨Ö Wstecz</button>
  <button id="addBtn" class="back-button" style="margin-left: 10px;" onclick="handleAddCustom()">‚ûï Dodaj</button>
  <button class="back-button" style="float:right;" onclick="showRecentEntries()">üìã Zobacz wpisy</button>
</div>

  <h2 id="step-title">Jak masz na imiƒô?</h2>

  <div class="screen active" id="step1">
    <div class="grid" id="workers"></div>
  </div>
<div class="screen" id="step2">
  <button onclick="fetchProjectsFromSheet()">üîÑ Aktualizuj projekty</button>
  <div class="grid" id="projects"></div>
</div>
  <div class="screen" id="step3">
    <div class="grid" id="categories"></div>
  </div>
 <div class="screen" id="step4">
  <!-- ‚û°Ô∏è tutaj przycisk od≈õwie≈ºania zada≈Ñ -->
  <div id="task-update-container" style="width:90%; max-width:800px; margin-bottom:10px; text-align:center;">
    <button onclick="handleUpdateTasks()">üîÑ Aktualizuj zadania</button>
  </div>

  <!-- lista kafelk√≥w z zadaniami -->
  <div class="grid tile-step4" id="subcategories"></div>

  <!-- wyb√≥r godzin -->
  <div id="hourSection" style="display:none;">
    <h3>Wybierz liczbƒô godzin:</h3>
    <div class="hour-options" id="hourTiles"></div>
  </div>
</div>
  <div class="screen" id="step5">
    <div id="summary"></div>
    <p><strong>≈ÅƒÖczna liczba godzin:</strong> <span id="totalHours">0</span> h</p>
    <button onclick="addAnotherProject()">Dodaj kolejny projekt</button>
    <button onclick="resetForm()">Zacznij od nowa</button>
    <button onclick="submitData()">Zapisz</button>
  </div>

  <script>
function renderProjects() {
  const all = Array.from(new Set(projects)).filter(Boolean);
  const recent = getRecentProjects().filter(p => all.includes(p));
  const others = all
    .filter(p => !recent.includes(p))
    .sort((a, b) => a.localeCompare(b, 'pl', { sensitivity: 'base' }));

  const container = document.getElementById('projects');
  container.innerHTML = '';

  if (recent.length) {
    container.insertAdjacentHTML('beforeend',
      '<div class="group-title">Ostatnio u≈ºywane:</div>');
    renderTileGroup(container, recent, selectProject);
  }
  container.insertAdjacentHTML('beforeend',
    '<div class="group-title">Wszystkie projekty:</div>');
  renderTileGroup(container, others, selectProject);

  addCustomProjectTile();
}

function renderTileGroup(container, items, onClick) {
  const group = document.createElement('div');
  group.className = 'project-group';
  items.forEach(item => {
    const div = document.createElement('div');
    div.className = 'tile tile-step2';
    div.innerText = item;
    div.onclick = () => {
      addRecentProject(item);
      div.classList.add('clicked');
      setTimeout(() => div.classList.remove('clicked'), 200);
      onClick(item);
    };
    group.appendChild(div);
  });
  container.appendChild(group);
}


// ‚Äî‚Äî‚Äî‚Äî‚Äî ZAMIENNIK showRecentEntries ‚Äî‚Äî‚Äî‚Äî‚Äî
async function showRecentEntries() {
  try {
    const now = new Date();
    const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

    // 1) pobieramy wszystkie wiersze
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SHEET_NAME_SAVE}!A2:F`,
    });
    const allEntries = res.result.values || [];

    // 2) mapujemy na obiekty z numerem wiersza w arkuszu (pierwszy wiersz to A2 ‚Üí rowIndex=2)
    const enriched = allEntries.map((row, i) => ({
      data: row,
      rowIndex: i + 2
    }));

    // 3) filtrujemy tylko ostatni tydzie≈Ñ
    const recent = enriched.filter(obj => {
      const d = new Date(obj.data[0]);
      return !isNaN(d) && d >= oneWeekAgo;
    });

    // 4) budujemy tabelƒô z dodatkowƒÖ kolumnƒÖ ‚ÄûEdytuj‚Äù
    const html = `
      <div id="entries-popup" style="position:fixed; top:10%; left:50%; transform:translateX(-50%);
                  background:white; padding:20px; box-shadow:0 0 10px rgba(0,0,0,0.3);
                  max-height:80vh; overflow:auto; z-index:9999; border-radius:12px;">
        <h3>Ostatnie wpisy</h3>
        <table style="font-size:0.8rem; border-collapse:collapse; width:100%;">
          <thead>
            <tr>
              <th style="border-bottom:1px solid #ccc;">Data</th>
              <th style="border-bottom:1px solid #ccc;">Pracownik</th>
              <th style="border-bottom:1px solid #ccc;">Projekt</th>
              <th style="border-bottom:1px solid #ccc;">Kategoria</th>
              <th style="border-bottom:1px solid #ccc;">Zadanie</th>
              <th style="border-bottom:1px solid #ccc;">Godziny</th>
              <th style="border-bottom:1px solid #ccc;">Edytuj</th>
            </tr>
          </thead>
          <tbody>
            ${recent.map(obj => `
              <tr>
                ${obj.data.map(col => `<td style="border:1px solid #eee; padding:4px;">${col}</td>`).join('')}
                <td style="border:1px solid #eee; padding:4px; text-align:center;">
                  <button onclick="editEntry(${obj.rowIndex})"
                    style="cursor:pointer;
                           background:none;
                           border:none;
                           padding:0;
                           margin:0;
                           line-height:1;
                           font-size:inherit;
                           vertical-align:middle;">
                    ‚úèÔ∏è
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <div style="text-align:center; margin-top:10px;">
          <button onclick="document.getElementById('entries-popup').remove()">Zamknij</button>
        </div>
      </div>
    `;
    // wstrzykniƒôcie
    const container = document.createElement('div');
    container.innerHTML = html;
    document.body.appendChild(container);

  } catch (e) {
    console.error("B≈ÇƒÖd pobierania wpis√≥w:", e);
    showToast("Nie uda≈Ço siƒô pobraƒá wpis√≥w", true);
  }
}

// Helpers: dostajesz i zapisujesz listƒô projekt√≥w w localStorage
function getCachedProjects() {
  try { return JSON.parse(localStorage.getItem('projekty')||'[]') }
  catch { return [] }
}
function setCachedProjects(arr) {
  localStorage.setItem('projekty', JSON.stringify(arr))
}

// fetch + cache + render
async function fetchProjectsFromSheet() {
  if (!gapiInited) return;
  try {
    const [base, custom] = await Promise.all([
      gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SHEET_NAME_LOAD}!A2:A`
      }),
      gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `NoweProjekty!A2:A`
      })
    ]);
    const baseList   = base.result.values?.flat()   || [];
    const customList = custom.result.values?.flat() || [];
    projects = Array.from(new Set([...baseList, ...customList].filter(Boolean)));
    setCachedProjects(projects);
    renderProjects(); 
    showToast("Projekty zaktualizowane");
  } catch (e) {
    console.error(e);
    showToast("B≈ÇƒÖd aktualizacji projekt√≥w", true);
  }
}

function getCachedTasks() {
  try { return JSON.parse(localStorage.getItem('tasksCache')||'{}') }
  catch { return {} }
}
function setCachedTasks(obj) {
  localStorage.setItem('tasksCache', JSON.stringify(obj))
}

// pobierz WSZYSTKIE zadania raz z arkusza, pogrupuj po kategorii
async function fetchTasksFromSheet() {
  if (!gapiInited) return {};
  try {
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `NoweZadania!A2:B`
    });
    const rows = res.result.values || [];
    const tasksByCat = {};
    rows.forEach(([cat, task]) => {
      if (cat && task) {
        tasksByCat[cat] = tasksByCat[cat]||[];
        if (!tasksByCat[cat].includes(task)) tasksByCat[cat].push(task);
      }
    });
    setCachedTasks(tasksByCat);
    return tasksByCat;
  } catch (e) {
    console.error(e);
    return getCachedTasks();
  }
}


function renderProjects() {
    const all = Array.from(new Set(projects)).filter(Boolean);
    const recent = getRecentProjects().filter(p => all.includes(p));
    const others = all
      .filter(p => !recent.includes(p))
      .sort((a, b) => a.localeCompare(b, 'pl', { sensitivity: 'base' }));

    const container = document.getElementById('projects');
    container.innerHTML = '';

    if (recent.length) {
      container.insertAdjacentHTML('beforeend',
        '<div class="group-title">Ostatnio u≈ºywane:</div>');
      renderTileGroup(container, recent, selectProject);
    }
    container.insertAdjacentHTML('beforeend',
      '<div class="group-title">Wszystkie projekty:</div>');
    renderTileGroup(container, others, selectProject);

    addCustomProjectTile();
  }
  function renderTileGroup(container, items, onClick) {
    const group = document.createElement('div');
    group.className = 'project-group';
    items.forEach(item => {
      const div = document.createElement('div');
      div.className = 'tile tile-step2';
      div.innerText = item;
      div.onclick = () => {
        addRecentProject(item);   // zapisz wyb√≥r
        div.classList.add('clicked');
        setTimeout(() => div.classList.remove('clicked'), 200);
        onClick(item);
      };
      group.appendChild(div);
    });
    container.appendChild(group);
  }

 async function resetForm() {
  state = { worker: null, entries: [] };
  loadProjectsFromStorage();
  if (!gapiInited) {
    setTimeout(resetForm, 250);
    return;
  }
  const statusMap = await fetchWorkerStatuses();
  showStep(1);
  renderTiles('workers', workers, worker => {
    state.worker = worker;
    showStep(2);
    renderProjects();
  }, statusMap);
}



async function editEntry(rowIndex) {
  // 1) Pobieramy starƒÖ warto≈õƒá
  const range = `${SHEET_NAME_SAVE}!A${rowIndex}:F${rowIndex}`;
  const getRes = await gapi.client.sheets.spreadsheets.values.get({
    spreadsheetId: SPREADSHEET_ID,
    range
  });
  const old = getRes.result.values?.[0] || [];
  const headers = ['Data','Pracownik','Projekt','Kategoria','Zadanie','Godziny'];

  // 2) Pytamy usera o nowe warto≈õci
  const updated = old.map((val,i) => {
    const inp = prompt(`Nowa warto≈õƒá dla ${headers[i]}:`, val);
    return inp == null ? val : inp;
  });

  // 3) Funkcja, kt√≥ra robi faktyczny update
  async function doUpdate() {
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range,
      valueInputOption: 'USER_ENTERED',
      resource: { values: [updated] }
    });
    showToast("Zaktualizowano wpis");
    // od≈õwie≈º popup
    document.getElementById('entries-popup').remove();
    showRecentEntries();
  }

  // 4) Je≈õli mamy ju≈º OAuth-owy token ‚Äî idziemy od razu, inaczej prosimy o dostƒôp
  const tok = gapi.client.getToken();
  if (!tok) {
    // nadpisujemy callback tokenClienta ≈ºeby po zalogowaniu wykonaƒá w≈Ça≈õnie doUpdate()
    tokenClient.callback = async (resp) => {
      if (resp.error) {
        console.error("Token error:", resp);
        showToast("Brak dostƒôpu do zapisu", true);
        return;
      }
      await doUpdate();
    };
    // prosimy o token
    tokenClient.requestAccessToken({ prompt: 'consent' });
  } else {
    // mamy token, jedziemy od razu
    await doUpdate();
  }
}



function showToast(msg, isError = false) {
  const toast = document.getElementById('toast');
  if (!toast) {
    console.warn("Toast element nie istnieje:", msg);
    return;
  }

  toast.textContent = msg;
  toast.classList.toggle('error', isError);
  toast.style.display = 'block';
  setTimeout(() => {
    toast.style.display = 'none';
  }, 5000);
}


function updateClock() {
  const now = new Date();
  const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  const dateStr = now.toLocaleDateString('pl-PL', options);
  const timeStr = now.toLocaleTimeString('pl-PL');
  document.getElementById('clock').innerText = `${dateStr}, ${timeStr}`;
}
setInterval(updateClock, 1000);
updateClock();


    // ‚Äî‚Äî‚Äî‚Äî‚Äî USTAWIENIA ‚Äî‚Äî‚Äî‚Äî‚Äî
    const API_KEY         = "AIzaSyDDihxqon-BeTzmC-vEE4kyhRJBXTlK_lA";
    const CLIENT_ID       = "614198520540-4ann4cs5o8pchgi1u15q6n08pj87n51o.apps.googleusercontent.com";
    const SPREADSHEET_ID  = "14t8T8GexDVVlO5v-C1T0VHz94LmM5FRRNg-sXPKh2GE";
    const DISCOVERY_DOCS  = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
    const SCOPES          = "https://www.googleapis.com/auth/spreadsheets";
    const SHEET_NAME_LOAD = "Projekty";
    const SHEET_NAME_SAVE = "CzasPracy";

    // ‚Äî‚Äî‚Äî‚Äî‚Äî ZMIENNE STANU OAuth ‚Äî‚Äî‚Äî‚Äî‚Äî
    let tokenClient;
    let gapiInited = false;
    let gisInited  = false;

    // ‚Äî‚Äî‚Äî‚Äî‚Äî CALLBACKI ≈ÅADOWANIA BIBLIOTEK ‚Äî‚Äî‚Äî‚Äî‚Äî
    function gapiLoaded() {
  gapi.load('client', () =>
    gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS })
      .then(() => {
        gapiInited = true;
        resetForm(); // ‚Üê przenie≈õ tutaj
      })
  );
}


    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
          if (resp.error) {
            console.error("Token error:", resp);
            return;
          }
          actuallySubmitData();
        }
      });
      gisInited = true;
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî DANE APLIKACJI ‚Äî‚Äî‚Äî‚Äî‚Äî
    const workers = ["Kamil","Pawe≈Ç","Piotr","Przemek","Robert"];
    const categories = ["Stal","Drewno","Monta≈º","Biuro"];
    const subcategoriesMap = {
      "Stal": ["Konstrukcja","Ciƒôcie","Szlifowanie","Malowanie proszkowe"],
      "Drewno": ["Szlifowanie","Lakierowanie","Docinanie","Klejenie"],
      "Monta≈º": ["Transport","Instalacja","Dostosowanie","Pomiar na miejscu"],
      "Biuro": ["Mailing","Faktury","Telefon","Projektowanie"]
    };
    let projects = [];
    let state = { worker: null, entries: [] };
    let currentEntry = null;
    let currentStep = 1;

    // ‚Äî‚Äî‚Äî‚Äî‚Äî POMOCNICZE ‚Äî‚Äî‚Äî‚Äî‚Äî
    function showStep(step) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(`step${step}`).classList.add('active');
      const titles = ["Wybierz swoje imiƒô","Wybierz projekt","Wybierz kategoriƒô","Wybierz zadanie","Podsumowanie"];
      document.getElementById('step-title').innerText = titles[step-1];
      document.getElementById('addBtn').style.display = (step === 2 || step === 4) ? 'inline-block' : 'none';
      document.querySelector('.back-button').style.display = (step === 1 ? 'none' : 'inline-block');
      currentStep = step;
      if (step === 4) renderHourTiles();
    }

// ‚Äî‚Äî‚Äî‚Äî‚Äî Zaktualizowany handleAddCustom ‚Äî‚Äî‚Äî‚Äî‚Äî
function handleAddCustom() {
  if (currentStep === 2) {
    const name = prompt("Podaj nazwƒô nowego projektu:");
    if (name && !projects.includes(name)) {
      projects.push(name);
      localStorage.setItem('projekty', JSON.stringify(projects));
      renderTiles('projects', projects, selectProject);
      addCustomProjectTile();
      saveNewItemToSheet(name, 'NoweProjekty');
    }
  }

  if (currentStep === 4 && currentEntry?.category) {
    const name = prompt("Podaj nazwƒô nowego zadania:");
    const list = subcategoriesMap[currentEntry.category] || [];
    if (name && !list.includes(name)) {
      list.push(name);
      subcategoriesMap[currentEntry.category] = list;
      renderTiles('subcategories', list, subcat => {
        currentEntry.subcategory = subcat;
        document.getElementById('hourSection').style.display = 'block';
      });
      // zamiast tylko nazwy ‚Äì zapisujemy te≈º kategoriƒô
      saveNewTaskToSheet(currentEntry.category, name);
    }
  }
}




async function saveNewItemToSheet(value, sheetName) {
  if (!value || !sheetName || !gapiInited) return;

  try {
    await gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${sheetName}!A:A`,
      valueInputOption: 'USER_ENTERED',
      insertDataOption: 'INSERT_ROWS',
      resource: { values: [[value]] }
    });
    showToast("Zapisano nowƒÖ pozycjƒô");
  } catch (err) {
    console.error("B≈ÇƒÖd zapisu nowej pozycji:", err);
    showToast("B≈ÇƒÖd zapisu nowej pozycji", true);
  }
}


    function goBack() {
      if (currentStep > 1) showStep(currentStep - 1);
    }

 // ‚Äî‚Äî‚Äî‚Äî‚Äî Zaktualizowana fetchWorkerStatuses() ‚Äî‚Äî‚Äî‚Äî‚Äî
async function fetchWorkerStatuses() {
  const statusMap = {};
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayStr = yesterday.toISOString().split('T')[0];

  // cache ‚Äì zwr√≥ƒá raz na dzie≈Ñ
  const cached = localStorage.getItem("workerStatusCache");
  if (cached) {
    try {
      const { date, statusMap: sm } = JSON.parse(cached);
      if (date === todayStr) return sm;
    } catch (e) { console.warn(e); }
  }

  // pobierz nowe
  try {
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID, range: `${SHEET_NAME_SAVE}!A2:F`
    });
    const entries = res.result.values || [];

    workers.forEach(worker => {
      const hasToday = entries.some(row => {
        const d = new Date(row[0]);
        return !isNaN(d)
          && d.toISOString().split('T')[0] === todayStr
          && row[1] === worker;
      });
      const hasYesterday = entries.some(row => {
        const d = new Date(row[0]);
        return !isNaN(d)
          && d.toISOString().split('T')[0] === yesterdayStr
          && row[1] === worker;
      });
      statusMap[worker] = hasToday ? 'green'
                        : hasYesterday ? 'yellow'
                        : 'red';
    });

    // zapisz cache
    localStorage.setItem("workerStatusCache", JSON.stringify({
      date: todayStr, statusMap
    }));
  } catch (e) {
    console.error(e);
    showToast("Nie uda≈Ço siƒô sprawdziƒá, kto siƒô wpisa≈Ç.", true);
  }

  return statusMap;
}


    function renderTiles(containerId, items, onClick, statusMap = {}) {
console.log("Rendertiles", { containerId, items, statusMap });

  const container = document.getElementById(containerId);
  container.innerHTML = '';
  const step = currentStep;

  const stepClass = {
    1: 'tile-step1',
    2: 'tile-step2',
    3: 'tile-step3',
    4: 'tile-step4'
  }[step] || 'tile';

  items.forEach(item => {
    const div = document.createElement('div');
    div.className = `tile ${stepClass}`;

    // Dodaj klasƒô statusu (je≈õli dotyczy)
    if (statusMap[item]) {
      div.classList.add(`tile-status-${statusMap[item]}`);
    }

    div.innerText = item;
    div.onclick = () => {
      div.classList.add('clicked');
      setTimeout(() => div.classList.remove('clicked'), 200);
      [...container.children].forEach(c => c.classList.remove('selected'));
      div.classList.add('selected');
      onClick(item);
    };
    container.appendChild(div);
  });
}


    // ‚Äî‚Äî‚Äî‚Äî‚Äî RESET I START ‚Äî‚Äî‚Äî‚Äî‚Äî
    function loadProjectsFromStorage() {
      const stored = localStorage.getItem('projekty');
      projects = stored ? JSON.parse(stored) : [];
    }

    async function resetForm() {
  state = { worker: null, entries: [] };
  loadProjectsFromStorage();

  // Je≈õli GAPI jeszcze siƒô nie za≈Çadowa≈Ço, poczekaj chwilƒô
  if (!gapiInited) {
    console.warn("Google API niegotowe, spr√≥bujƒô ponownie za 250ms...");
    setTimeout(resetForm, 250);
    return;
  }

  const statusMap = await fetchWorkerStatuses();
  showStep(1);
  renderTiles('workers', workers, worker => {
    state.worker = worker;
    showStep(2);
    renderTiles('projects', projects, selectProject);
    addCustomProjectTile();
  }, statusMap);
}

    // ‚Äî‚Äî‚Äî‚Äî‚Äî DYNAMICZNE TILES ‚Äî‚Äî‚Äî‚Äî‚Äî
    function addCustomProject() {
  const name = prompt("Podaj nazwƒô nowego projektu:");
  if (name && !projects.includes(name)) {
    projects.push(name);
    localStorage.setItem('projekty', JSON.stringify(projects));
    renderTiles('projects', projects, selectProject);
    addCustomProjectTile();
    // zapisujemy do arkusza NoweProjekty
    saveNewItemToSheet(name, 'NoweProjekty');
  }
}


    function addCustomProjectTile() {
      const t = document.createElement('div');
      t.className = 'tile';
      t.innerText = '+ Dodaj projekt';
      t.onclick = addCustomProject;
      document.getElementById('projects').appendChild(t);
    }

// ‚Äî‚Äî‚Äî‚Äî‚Äî NOWA funkcja do zapisu nowych zada≈Ñ w dw√≥ch kolumnach (kategoria + nazwa) ‚Äî‚Äî‚Äî‚Äî‚Äî
async function saveNewTaskToSheet(category, taskName) {
  if (!category || !taskName || !gapiInited) return;
  try {
    await gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `NoweZadania!A:B`,                // kolumna A = kategoria, B = zadanie
      valueInputOption: 'USER_ENTERED',
      insertDataOption: 'INSERT_ROWS',
      resource: { values: [[ category, taskName ]] }
    });
    showToast("Zapisano nowe zadanie");
  } catch (err) {
    console.error("B≈ÇƒÖd zapisu nowego zadania:", err);
    showToast("B≈ÇƒÖd zapisu nowego zadania", true);
  }
}

function getRecentProjects() {
    try { return JSON.parse(localStorage.getItem('recentProjects')) || []; }
    catch { return []; }
  }
  function addRecentProject(name) {
    const recent = getRecentProjects();
    const idx = recent.indexOf(name);
    if (idx !== -1) recent.splice(idx, 1);
    recent.unshift(name);
    localStorage.setItem('recentProjects', JSON.stringify(recent.slice(0, 7)));
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî Zmodyfikowana selectProject ‚Äî‚Äî‚Äî‚Äî‚Äî
 function selectProject(project) {
    currentEntry = { project, category: null, subcategory: null, hours: 0 };
    showStep(3);
    renderTiles('categories', categories, async cat => {
      currentEntry.category = cat;
      showStep(4);
      const staticList = subcategoriesMap[cat] || [];
      const cached     = getCachedTasks()[cat] || [];
      renderTiles(
        'subcategories',
        Array.from(new Set([...staticList, ...cached])),
        subcat => {
          currentEntry.subcategory = subcat;
          document.getElementById('hourSection').style.display = 'block';
        }
      );
    });
  }

// obs≈Çuga przycisku
async function handleUpdateTasks() {
  if (!currentEntry?.category) return;
  const tasksByCat = await fetchTasksFromSheet();
  const list = Array.from(new Set([
    ...(subcategoriesMap[currentEntry.category]||[]),
    ...(tasksByCat[currentEntry.category]||[])
  ]));
  renderTiles('subcategories', list, subcat => {
    currentEntry.subcategory = subcat;
    document.getElementById('hourSection').style.display = 'block';
  });
  showToast("Zadania zaktualizowane");
}



    function renderHourTiles() {
      const c = document.getElementById('hourTiles');
      c.innerHTML = '';
      for (let i=1; i<=16; i++){
        const d = document.createElement('div');
        d.className = 'tile';
        d.innerText = i;
        d.onclick = () => {
          currentEntry.hours = i;
          tryFinishEntry();
        };
        c.appendChild(d);
      }
    }

    function tryFinishEntry() {
      if (currentEntry.subcategory && currentEntry.hours>0) {
        state.entries.push({ ...currentEntry });
        showStep(5);
        renderSummary();
      }
    }

    function renderSummary() {
      const summary = document.getElementById('summary');
      let total = 0;
      summary.innerHTML = '';
      const header = document.createElement('p');
      header.innerHTML = `<strong>Pracownik:</strong> ${state.worker}`;
      summary.appendChild(header);
      const container = document.createElement('div');
      container.className = 'summary-entry-container';
      state.entries.forEach((e,i) => {
        total += e.hours;
        const div = document.createElement('div');
        div.className = 'summary-entry';
        div.innerHTML = `
          <button class="remove-btn" onclick="removeEntry(${i})">‚ùå</button>
          <p><strong>${e.project}</strong><br>${e.category} / ${e.subcategory}</p>
          <div class="hour-options">
            ${Array.from({length:16},(_,h)=>{
              const hv = h+1;
              return `<div class="tile ${e.hours===hv?'selected':''}" onclick="updateHours(${i},${hv})">${hv}</div>`;
            }).join('')}
          </div>
        `;
        container.appendChild(div);
      });
      summary.appendChild(container);
      const totalSpan = document.getElementById('totalHours');
      totalSpan.innerText = total;
      totalSpan.className = `total-hours ${total>9?'red':'green'}`;
    }

    function removeEntry(idx) {
      state.entries.splice(idx,1);
      renderSummary();
    }
    function updateHours(idx,val) {
      state.entries[idx].hours = val;
      renderSummary();
    }
    function addAnotherProject(){
      showStep(2);
      renderTiles('projects', projects, selectProject);
      addCustomProjectTile();
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî ZAPIS DO SHEETS ‚Äî‚Äî‚Äî‚Äî‚Äî
    function submitData() {
      if (!gapiInited || !gisInited) {
        alert("Trwa inicjalizacja Google API, spr√≥buj za chwilƒô.");
        return;
      }
      const tok = gapi.client.getToken();
      if (!tok) {
        tokenClient.requestAccessToken({ prompt: 'consent' });
      } else {
        actuallySubmitData();
      }
    }

    async function actuallySubmitData() {
      try {
        const values = state.entries.map(e => [
        formatDateForSheets(new Date()),
        state.worker, e.project, e.category, e.subcategory, e.hours
      ]);
        await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: `${SHEET_NAME_SAVE}!A1`,
          valueInputOption: 'USER_ENTERED',
          insertDataOption: 'INSERT_ROWS',
          resource: { values }
        });
        resetForm();             // ju≈º masz tƒô liniƒô‚Ä¶
console.log('‚Äî po zapisie: ponowne pobranie status√≥w ‚Äî');
showToast("Dane zosta≈Çy zapisane!");
      } catch (err) {
        console.error("B≈ÇƒÖd zapisu:", err);
        alert("Nie uda≈Ço siƒô zapisaƒá danych.");
      }
    }


    // ‚Äî‚Äî‚Äî‚Äî‚Äî ZAMIENNIK fetchProjectsFromSheet ‚Äî‚Äî‚Äî‚Äî‚Äî
async function fetchProjectsFromSheet() {
  if (!gapiInited) return;
  try {
    const [base, custom] = await Promise.all([
      gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: `${SHEET_NAME_LOAD}!A2:A` }),
      gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: `NoweProjekty!A2:A` })
    ]);
    const baseList   = base.result.values?.flat()   || [];
    const customList = custom.result.values?.flat() || [];
    projects = Array.from(new Set([...baseList, ...customList].filter(Boolean)));
    setCachedProjects(projects);
    renderProjects();
    showToast("Projekty zaktualizowane");
  } catch (e) {
    console.error(e);
    showToast("B≈ÇƒÖd aktualizacji projekt√≥w", true);
  }
}


// ‚Äî‚Äî‚Äî‚Äî‚Äî NOWA funkcja pobierajƒÖca zadania z arkusza NoweZadania ‚Äî‚Äî‚Äî‚Äî‚Äî
async function fetchSubcategoriesFromSheet(category) {
  try {
    const res = await fetch(
      `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/NoweZadania!A2:B?key=${API_KEY}`
    );
    const data = await res.json();
    if (!data.values) return [];

    // oczekujemy, ≈ºe w kolumnie A jest kategoria, w kolumnie B nazwa zadania
    return data.values
      .filter(row => row[0] === category && row[1])
      .map(row => row[1]);
  } catch (e) {
    console.error("B≈ÇƒÖd pobierania nowych zada≈Ñ:", e);
    return [];
  }
}


function formatDateForSheets(date) {
  const pad = n => n.toString().padStart(2, '0');
  return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
}


    // ‚Äî‚Äî‚Äî‚Äî‚Äî START ‚Äî‚Äî‚Äî‚Äî
  </script>
<!-- Eruda: <script src="https://cdn.jsdelivr.net/npm/eruda"></script> < --konsola na urzƒÖdzeniach mobilnych -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    eruda.init({
      // kt√≥re narzƒôdzia pokazaƒá
      tool: ['console', 'elements', 'network', 'resources'],
      // domy≈õlne opcje
      defaults: {
        // automatycznie poka≈º panel po init()
        autoShow: true,
        // procent wysoko≈õci ekranu dla panelu
        displaySize: 40
      }
    });
    // wymuszone otwarcie
    eruda.show();
  });
gapiLoaded();
gisLoaded();
</script>


</body>
</html>
